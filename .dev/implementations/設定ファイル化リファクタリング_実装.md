# 設定ファイル化リファクタリング実装

## 実装日時
2025-11-23

## 概要
Issue自動改善機能のテンプレート設定とシステムプロンプトを外部設定ファイル化し、コード配置を整理しました。

## 実装内容

### 1. 設定ファイルの導入

#### `.improve_issue.yml` の作成
- テンプレート定義とシステムプロンプトを YAML 形式で外部化
- 日本語・英語の両方のキーワードに対応
- デフォルトテンプレートの指定

**配置場所:**
- リポジトリルート直下: `.improve_issue.yml`
- 環境変数 `IMPROVE_ISSUE_CONFIG` で任意のパスを指定可能

**設定構造:**
```yaml
default_template: feature_request

templates:
  feature_request:
    issue_template_file: feature_request
    system_prompt: |
      システムプロンプトの内容...
    keywords:
      - 日本語キーワード
      - English keyword
      ...
```

### 2. コード配置の整理

**移動元:** `.github/scripts/improve_issue.py`  
**移動先:** `src/github_actions_ai_improve_issue/main.py`

**削除したファイル:**
- `.github/scripts/improve_issue.py` - 旧スクリプト
- `src/github_actions_ai_improve_issue/main.py` - 旧実装

**新規作成:**
- `src/github_actions_ai_improve_issue/main.py` - 設定ファイル対応版

### 3. ハードコードの削除

**削除した定数:**
- `ROLE_AND_INSTRUCTIONS` - システムプロンプトの定義
- `TemplateDetector.KEYWORDS` - テンプレート判定キーワード

**設定ファイル化:**
- システムプロンプトは各テンプレートの `system_prompt` に
- キーワードは各テンプレートの `keywords` に
- テンプレート型定義は動的に設定から読み込み

### 4. コード品質の改善

#### リポジトリルート検出の共通化
```python
def find_repo_root() -> Path:
    """リポジトリルートを探索
    
    .git ディレクトリを探して、見つからない場合はフォールバック
    """
    current = Path(__file__).resolve()
    for parent in [current] + list(current.parents):
        if (parent / ".git").exists():
            return parent
    
    return Path(__file__).resolve().parents[2]
```

**改善点:**
- `.git` ディレクトリの存在チェックによる堅牢な実装
- すべての箇所で `find_repo_root()` を使用（DRY原則）
- フォールバックロジック付き

#### 設定読み込みの実装
```python
def load_settings() -> ImproveIssueSettings:
    """設定ファイルを読み込む"""
    # 環境変数またはデフォルトパスから設定ファイルを読み込み
    # バリデーションを実施
    # データクラスにマッピング
```

**特徴:**
- 明確なエラーメッセージ
- 設定の妥当性チェック
- 型安全なデータ構造

### 5. GitHub Actions ワークフローの更新

**変更前:**
```yaml
run: |
  uv run .github/scripts/improve_issue.py
```

**変更後:**
```yaml
run: |
  uv run -m github_actions_ai_improve_issue.main
```

### 6. 依存関係の追加

`pyproject.toml` に追加:
```toml
dependencies = [
    ...
    "pyyaml>=6.0",
]
```

## テスト結果

### 基本機能テスト

#### 設定ファイル読み込み
```bash
✅ 設定ファイル読み込み成功
✅ デフォルトテンプレート: feature_request
✅ テンプレート数: 2
  - feature_request: 14 keywords
  - bug_report: 12 keywords
```

#### テンプレート判定（日本語）
```bash
✅ '新しい機能を追加したい' → feature_request
✅ 'エラーが発生して動かない' → bug_report
```

#### テンプレート判定（英語）
```bash
✅ 'I want to add a new feature' → feature_request
✅ 'There is a bug and error' → bug_report
```

#### リポジトリルート検出
```bash
✅ リポジトリルート: /path/to/repo
```

### セキュリティチェック

#### CodeQL
```bash
✅ actions: No alerts found
✅ python: No alerts found
```

## 技術的な注意点

### 必須要件
- 設定ファイル `.improve_issue.yml` が必須
- 見つからない場合は明確なエラーメッセージで終了
- フォールバック・デフォルト値は一切なし

### 後方互換性
設計書の指示通り、後方互換性は一切考慮していません。
- 旧スクリプトは削除
- 設定ファイル必須化
- フォールバックなし

### 国際化対応
- デフォルト設定で日本語・英語の両方のキーワードをサポート
- ユーザーは必要に応じて他言語のキーワードを追加可能

## ドキュメント更新

### README.md
以下のセクションを追加・更新:
- 設定ファイルの必須化
- 設定ファイルの構造と説明
- テンプレートのカスタマイズ方法
- 実行方法の更新（全て新しいパスに）
- 英語キーワード対応の明記

### ファイル構成図
```
.improve_issue.yml              # 設定ファイル（必須）
README.md
.github/
├── ISSUE_TEMPLATE/
│   ├── bug_report.md
│   └── feature_request.md
└── workflows/
    └── issue_auto_improve.yml
src/
└── github_actions_ai_improve_issue/
    ├── __init__.py
    └── main.py                 # メインスクリプト
```

## コードレビューでの改善点

1. **リポジトリルート検出の統一**
   - `find_repo_root()` 関数を作成
   - すべての箇所で使用

2. **堅牢なパス解決**
   - `.git` ディレクトリの検索による自動検出
   - フォールバックロジック

3. **英語キーワードの追加**
   - 国際的な貢献者をサポート
   - デフォルト設定に含める

## まとめ

設計書に基づいて、以下を達成しました:

✅ 設定ファイルによるテンプレート管理  
✅ システムプロンプトの外部化  
✅ コード配置の整理  
✅ ハードコードの削除  
✅ 堅牢なリポジトリルート検出  
✅ 国際化対応（日英キーワード）  
✅ ドキュメントの充実  
✅ セキュリティチェック通過  

後方互換性を持たない、完全に新しい設計での実装が完了しました。
