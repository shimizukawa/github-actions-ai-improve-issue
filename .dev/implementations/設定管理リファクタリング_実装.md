# 設定管理リファクタリング - 実装記録

## 対応内容

環境変数の設定読み込みが全体に散らばっていて、コードも利用に必要な設定も分かりづらい問題を解決するため、環境変数を一元管理する`Config`クラスを実装しました。

### 対応範囲

- 環境変数読み込みを一元管理する`Config`クラスを作成
- 必須環境変数とオプション環境変数を明確に区別
- スクリプト全体で分散している`os.environ.get()`や`os.getenv()`呼び出しを`Config`クラス経由に変更
- 環境変数の検証ロジックを集約
- コードのメンテナンス性と可読性を向上

### 対応範囲外

- 機能追加や動作変更は行わない
- テンプレート、ワークフローファイル、その他の設定ファイルの変更は不要
- 既存のテストは存在しないため、新規テスト追加は行わない

## 技術的な詳細

### 1. Configクラスの実装

```python
class Config:
    """環境変数の一元管理クラス
    
    全ての環境変数の取得を集約し、設定の可視性を向上させる。
    必須環境変数とオプション環境変数を明確に区別する。
    """

    def __init__(self):
        # GitHub関連（GitHub Actions実行時に自動設定）
        self.github_repository: str = os.environ.get("GITHUB_REPOSITORY", "")
        self.github_token: str = os.environ.get("GITHUB_TOKEN", "")

        # Issue情報（通常モード実行時に必要）
        self.issue_body: str = os.environ.get("ISSUE_BODY", "")
        self.issue_title: str = os.environ.get("ISSUE_TITLE", "")
        self.issue_number: str = os.environ.get("ISSUE_NUMBER", "")

        # LLM API（通常モード実行時に必須）
        self.llm_api_key: str = os.environ.get("LLM_API_KEY", "")

        # RAG機能（オプション - 全て設定された場合のみ有効化）
        self.qdrant_url: str = os.environ.get("QDRANT_URL", "")
        self.qdrant_api_key: str = os.environ.get("QDRANT_API_KEY", "")
        self.voyage_api_key: str = os.environ.get("VOYAGE_API_KEY", "")
```

### 2. 環境変数の分類

#### 必須環境変数（通常モード）
- `ISSUE_NUMBER`: Issue番号
- `LLM_API_KEY`: LLM APIキー（Gemini）

#### GitHub操作用環境変数
- `GITHUB_TOKEN`: GitHub認証トークン
- `GITHUB_REPOSITORY`: リポジトリ名（owner/repo形式）

#### RAG機能用環境変数（オプション）
- `QDRANT_URL`: Qdrant CloudのURL
- `QDRANT_API_KEY`: Qdrant APIキー
- `VOYAGE_API_KEY`: Voyage AI APIキー

### 3. 検証メソッド

環境変数の検証ロジックを専用メソッドに分離：

```python
def validate_for_normal_mode(self):
    """通常モード実行時の必須環境変数チェック"""
    if not self.issue_number:
        raise ValueError("Error: ISSUE_NUMBER not set")
    if not self.llm_api_key:
        raise ValueError("Error: LLM_API_KEY not set")

def validate_for_github_operations(self):
    """GitHub操作が必要な場合の環境変数チェック"""
    if not self.github_token:
        raise ValueError("Error: GITHUB_TOKEN not set")
    if not self.github_repository:
        raise ValueError("Error: GITHUB_REPOSITORY not set")

def validate_for_rag_operations(self):
    """RAG操作が必要な場合の環境変数チェック"""
    if not self.voyage_api_key:
        raise ValueError("Error: VOYAGE_API_KEY not set")
    if not self.qdrant_url:
        raise ValueError("Error: QDRANT_URL not set")
    if not self.qdrant_api_key:
        raise ValueError("Error: QDRANT_API_KEY not set")
```

### 4. RAG機能有効化判定

RAG機能の有効化判定をプロパティとして実装：

```python
@property
def is_rag_enabled(self) -> bool:
    """RAG機能が有効かどうか"""
    return bool(
        self.qdrant_url and self.qdrant_api_key and self.voyage_api_key
    )
```

**変更前**:
```python
if (
    os.getenv("QDRANT_URL")
    and os.getenv("QDRANT_API_KEY")
    and os.getenv("VOYAGE_API_KEY")
):
    # RAG機能を使用
```

**変更後**:
```python
if config.is_rag_enabled:
    # RAG機能を使用
```

### 5. 関数シグネチャの変更

環境変数を直接読み込む代わりに、Configオブジェクトを渡すように変更：

#### 変更例1: fetch_issue_from_github

**変更前**:
```python
def fetch_issue_from_github(issue_number: int, github_token: str) -> dict | None:
    repo = os.environ.get("GITHUB_REPOSITORY", "")
    # ...
```

**変更後**:
```python
def fetch_issue_from_github(issue_number: int, config: Config) -> dict | None:
    if not config.github_repository:
        print("Error: GITHUB_REPOSITORY not set")
        return None
    # ...
```

#### 変更例2: index_all_issues

**変更前**:
```python
def index_all_issues(start: int = 1, end: int | None = None):
    github_token = os.environ.get("GITHUB_TOKEN", "")
    if not github_token:
        print("Error: GITHUB_TOKEN not set")
        sys.exit(1)
    # ...
    voyage_client = VoyageEmbeddingClient(api_key=os.environ["VOYAGE_API_KEY"])
```

**変更後**:
```python
def index_all_issues(config: Config, start: int = 1, end: int | None = None):
    config.validate_for_github_operations()
    config.validate_for_rag_operations()
    # ...
    voyage_client = VoyageEmbeddingClient(api_key=config.voyage_api_key)
```

### 6. main()関数の簡素化

**変更前**:
```python
def main():
    # ...
    issue_body = os.environ.get("ISSUE_BODY", "")
    issue_title = os.environ.get("ISSUE_TITLE", "")
    issue_number = os.environ.get("ISSUE_NUMBER", "")
    api_key = os.environ.get("LLM_API_KEY", "")
    
    if not issue_number:
        print("Error: ISSUE_NUMBER not set")
        sys.exit(1)
    
    if not api_key:
        print("Error: LLM_API_KEY not set")
        sys.exit(1)
    
    # RAG機能チェック
    if (
        os.getenv("QDRANT_URL")
        and os.getenv("QDRANT_API_KEY")
        and os.getenv("VOYAGE_API_KEY")
    ):
        # RAG機能を使用
```

**変更後**:
```python
def main():
    # ...
    config = Config()
    
    try:
        config.validate_for_normal_mode()
    except ValueError as e:
        print(str(e))
        sys.exit(1)
    
    # RAG機能チェック
    if config.is_rag_enabled:
        # RAG機能を使用
```

## 変更前後の比較

### 統計

- 変更行数: +136行, -90行
- 環境変数読み込み箇所: 18箇所 → 1箇所（Configクラス）
- 環境変数検証ロジック: 各関数に分散 → 3つのメソッドに集約

### メリット

1. **可読性の向上**
   - 全ての環境変数が1箇所で定義されている
   - 必須/オプション環境変数が明確

2. **保守性の向上**
   - 新しい環境変数の追加が容易
   - 環境変数名の変更が1箇所で済む

3. **テスト容易性の向上**
   - Configオブジェクトをモックすることで、テストが容易になる

4. **エラーハンドリングの改善**
   - 検証ロジックが集約され、エラーメッセージが統一的

## セキュリティチェック

CodeQL Checkerで検証済み:
- **Python**: 0件のアラート

## 確認項目

- [x] Pythonシンタックスチェック合格
- [x] コードフォーマッティング実行（uv format）
- [x] スクリプト起動確認（--helpオプション）
- [x] CodeQL Checkerによるセキュリティチェック合格
- [ ] 実際のGitHub Actions環境での動作確認（PRマージ後）

## 残課題

特になし。既存機能の動作は保たれ、コードの可読性と保守性が向上しました。
