# Issue自動ブラッシュアップ機能 - 要件

## 概要

簡易なブランクIssueに1-2行程度のやりたいことを書いたら、過去の類似Issue情報を参考に適切なテンプレートに沿った具体的な文章を自動生成し、コメントで提示する機能を実装する。

## 背景・現状の課題

### Issue作成時の課題

1. **テンプレート記入の心理的障壁**
   - テンプレートの各項目を埋めるのが面倒
   - 何を書けばいいのか分からず、手が止まる
   - 適切な文言を考えるのに時間がかかる

2. **テンプレート選択の難しさ**
   - 要件・設計・実装など、どのテンプレートを使うべきか判断が難しい
   - テンプレート選択を間違えると後で修正が必要

3. **記述内容の抽象化**
   - 書いた内容が抽象的になりがち
   - 目的や背景が不明確なまま提出される
   - 具体的な情報が不足し、レビュー時に追加質問が発生

4. **過去事例の活用不足**
   - 類似したIssueが過去にあっても参照されない
   - 同じような議論が繰り返される
   - 過去の知見が蓄積されない

### 結果として生じる問題

- Issue作成のハードルが高く、気軽に起票できない
- Issue品質のばらつきが大きい
- レビュアーが毎回同じ質問をする手間
- Issue完了までの往復コミュニケーションコストの増加

## 目的

### 解決したいこと

1. **Issue作成の心理的ハードルを下げる**
   - やりたいことを1-2行書くだけでOK
   - テンプレート選択を自動化
   - 文章作成の手間を削減

2. **AI生成例文による記述支援**
   - 過去の類似Issueを参考にした具体的な例文を提示
   - テンプレートの各項目を自動的に埋めた下書きを生成
   - ユーザーは生成された例文を実情に合わせて微修正するだけ

3. **Issue品質の底上げ**
   - テンプレートに沿った構造化された内容
   - 過去の知見を反映した具体的な記述
   - 必要な情報項目の記入漏れを防止

4. **低コストでの情報充実化**
   - AI生成文をベースに人間が最小限の編集で完成
   - 一から書くよりも圧倒的に低コスト
   - 具体的な例があるため、何を書けばいいか明確

### 解決しないこと

- Issue内容の妥当性判断（技術的実現可能性等）
- Issue優先度の自動決定
- 完全自動でのIssue完成（人間の確認・修正は必須）

## ユースケース

### 基本フロー

1. ユーザーがブランクIssueを作成し、やりたいことを1-2行で記述
   ```
   例: 「想定運転データの一括登録機能を追加したい」
   ```

2. GitHub Actions Workflowが自動起動

3. 簡易記述から適切なテンプレートを判定
   - 要件Issue（feature-1）
   - 設計Issue（feature-2-design）
   - その他

4. RAGで類似Issue情報を検索・取得

5. 判定したテンプレートに沿って、過去事例を参考にした具体的な文章を生成

6. Issueにコメントとして生成された例文を投稿
   ```markdown
   ## 🤖 AIによるIssue記入例
   
   [選定テンプレート: 機能要件（親Issue）]
   
   ### 背景・目的
   （具体的な文章例）
   
   ### 完了条件
   - [ ] ...
   
   （以下、テンプレートに沿った内容）
   ```

7. ユーザーは生成された例文を見て、実情に合わせて微修正
   - Issue本文を更新 or コメント内容を参考に追記

### 将来的な拡張

- Issue本文が更新された際にも再度ブラッシュアップを実行
- ブラッシュアップコメントを更新（上書き or 追記）

## 完了条件（Acceptance Criteria）

### 機能的な完了条件

- [ ] ブランクIssue作成時にGitHub Actions Workflowが自動起動される
- [ ] Issue本文（1-2行の簡易記述）から適切なテンプレートを自動判定できる
  - 要件Issue、設計Issue、バグ報告、実装Issueの4種類を判定
- [ ] 過去の類似Issueを検索し、Top-3〜5件を取得できる
- [ ] 判定したテンプレートに沿った具体的な例文が生成される
  - テンプレートの主要項目（背景・目的、完了条件、影響範囲等）を網羅
- [ ] 生成された例文がIssueコメントとして自動投稿される
- [ ] コメントには選定したテンプレートと参考にした類似Issueの情報が含まれる
  - 類似度スコア
  - Issue番号とタイトル
  - Issue URL
  - 類似している点の説明
- [ ] 参考にした類似IssueがIssue本文の「関連Issue」欄に自動リンクされる

### 品質的な完了条件

- [ ] テンプレート判定精度が80%以上（手動評価10件）
  - 人間が判断するテンプレートと一致
- [ ] 生成された例文がテンプレートの必須項目を90%以上網羅している
- [ ] 類似Issue検索の適合率が60%以上
  - Top-3のうち少なくとも2件は実際に関連している内容
- [ ] 生成された例文が具体的で実用的である
  - 抽象的・汎用的すぎる文章ではない
  - ユーザーが微修正で使える品質

### 非機能的な完了条件

- [ ] GitHub Actions Workflow実行時間が5分以内
- [ ] API呼び出し失敗時も正常終了し、エラーメッセージを投稿
- [ ] 既に詳細が記述されているIssueには反応しない（誤動作防止）
- [ ] 特定ラベル（`no-ai-assist`等）がついたIssueは処理をスキップ
- [ ] 同じIssueに対して重複してコメントを投稿しない

### ユーザー体験の完了条件

- [ ] ユーザーが生成された例文を見て、何を修正すればいいか理解できる
- [ ] 例文を元に5分以内で実情に合わせた修正ができる
- [ ] Issue作成の心理的ハードルが下がったとユーザーが感じる（アンケート実施）

### 開発・検証の完了条件

- [ ] ローカル環境で `--dry-run` で動作検証できる
- [ ] コンソール出力のみモードで生成結果を確認できる
- [ ] `--index-issues` で既存Issue全件のベクトル化ができる（Phase 2）
- [ ] `--index-issues --start N --end N` で範囲指定処理ができる（Phase 2）
- [ ] インデックス処理時のエラーハンドリングが適切（1件失敗しても継続）

## 機能仕様

### テンプレート自動判定

**判定対象:**
- ブランクIssue、または短い記述（1-2行程度）のIssue

**判定先テンプレート:**
- 要件Issue（feature-1テンプレート）
- 設計Issue（feature-2-designテンプレート）
- バグ報告（bug_reportテンプレート）
- 実装Issue（feature-3-codingテンプレート）

**判定方法:**
- Issue本文の内容からLLMで判定
- キーワード・文脈からどのテンプレートが適切か推定

**非対象:**
- すでに十分に記述されているIssue（テンプレートに沿って詳細が書かれている）

### 参考情報の範囲

**含める情報:**
- 過去の類似Issueの本文
- 過去の類似Issueのコメント（完了に必要な議論内容を含む）
- 将来的に追加: プロジェクトドキュメント（`.dev/`配下等）

**含めない情報:**
- Pull Request（実装寄りのため）

### ブラッシュアップの観点

1. **テンプレート準拠性**: 対応するテンプレートの項目が埋まっているか
2. **情報の網羅性**: 過去の類似Issueで必要とされた情報が含まれているか
3. **具体性**: 抽象的な記述を具体的な記述に改善
4. **関連情報の補完**: 依存関係、参考資料、前提知識の提示

### 出力形式

**コメント投稿:**
- 対象IssueにGitHub Actions Botアカウントでコメント投稿
- Markdown形式
- ブラッシュアップされた内容 + 改善提案の根拠を明示

**コメント構成例:**
```markdown
## 🤖 AIによるIssue記入例

**選定テンプレート**: 機能要件（親Issue）

### 背景・目的
（生成された具体的な文章）

### 完了条件
- [ ] ...

### 影響範囲
（生成された内容）

---

### 📚 参考にした類似Issue

この例文は以下の過去Issueを参考に生成しています：

1. **#123: 想定運転データCSV一括登録機能** (closed)
   - 類似度: 85%
   - https://github.com/owner/repo/issues/123
   - 類似点: データ一括登録の要件定義、CSVフォーマット設計

2. **#156: 運転計画データインポート機能追加** (closed)
   - 類似度: 72%
   - https://github.com/owner/repo/issues/156
   - 類似点: バリデーション要件、エラーハンドリング

3. **#201: 生産計画データ登録API実装** (open)
   - 類似度: 68%
   - https://github.com/owner/repo/issues/201
   - 類似点: データ登録フロー、テスト観点
```

**Issue本文への参考情報追加:**
- 生成後、Issue本文の「関連Issue」セクションに類似Issueのリンクを自動追加
- または、Issueのサイドバーに「Related Issues」として自動リンク（GitHub APIの制約により検討）

## 技術要件

### LLM選定（2025年11月時点）

**Phase別推奨モデル:**

| Phase | 推奨モデル | 理由 | 月額コスト目安 |
|-------|----------|------|-------------|
| Phase 0 | Gemini 2.0 Flash-Lite | 検証用、極低コスト | 約1円 |
| Phase 1-2 | Gemini 2.5 Flash | コスパ良好、ハイブリッド推論 | 約9円 |
| Phase 2 | Claude 3.7 Sonnet | 最高品質、推論強化 | 約54円 |

**主要モデル比較（入力/出力、100万トークンあたり）:**

| モデル | 入力 | 出力 | 特徴 |
|--------|------|------|------|
| Gemini 2.0 Flash-Lite | $0.075 | $0.30 | 超低コスト |
| Gemini 2.5 Flash | $0.30 | $2.50 | コスパ良好、日本語強い |
| GPT-4o-mini | $0.15 | $0.60 | バランス型 |
| Claude 3.7 Sonnet | $3.00 | $15.00 | 最高品質、拡張思考対応 |

**参考: 2025年10月 Nejumi Leaderboard 日本語LLMランキング**
- Gemini 2.5 Pro: 1位（コーディング性能 0.6449）
- Claude 3.7 Sonnet: 8位（0.5940）
- Gemini 2.5 Flash: 30位（0.5004）

### アーキテクチャ概要

```
[GitHub Issue作成]
    ↓
[GitHub Actions Workflow起動]
    ↓
[対象Issue内容取得]
    ↓
[ベクトル検索で類似Issue取得] ← [Qdrant Cloud]
    ↓
[LLMでブラッシュアップ案生成]
    ↓
[Issueにコメント投稿 or コンソール出力]  ← 環境変数で切替
```

### ローカル開発・検証モード

スクリプトは実行モードを引数で切り替える：

```bash
# モード1: 単一Issue改善（デフォルト）
uvx .github/scripts/improve_issue.py [--dry-run]

# モード2: RAGデータ生成
uvx .github/scripts/improve_issue.py --index-issues [--start N] [--end N]
```

#### モード1: 単一Issue改善モード

**通常実行（本番・GitHub Actions）:**
```bash
export ISSUE_NUMBER="123"
export GITHUB_TOKEN="your-github-token"
export GITHUB_REPOSITORY="owner/repo"
export LLM_API_KEY="your-api-key"

uvx .github/scripts/improve_issue.py
# → Issue #123 を改善してコメント投稿
```

**検証実行（ローカル開発）:**
```bash
export ISSUE_NUMBER="123"
export GITHUB_TOKEN="your-github-token"
export GITHUB_REPOSITORY="owner/repo"
export LLM_API_KEY="your-api-key"

uvx .github/scripts/improve_issue.py --dry-run
# → 実際のIssue #123 からデータを取得
# → RAG検索で類似Issueも取得（Phase 2以降）
# → LLMで生成
# → コンソールに出力のみ（コメント投稿なし）
```

**動作詳細:**
- GitHub APIでIssue情報を取得（読取り）
- RAG検索で類似Issueを取得（Phase 2以降）
- LLM APIで例文生成
- `--dry-run` 指定時: **コメント投稿のみスキップ**、結果を標準出力

#### モード2: RAGデータ生成モード（Phase 2以降）

既存の全Issue（または指定範囲）をベクトル化してQdrantに登録：

**全Issue登録:**
```bash
export GITHUB_TOKEN="your-github-token"
export GITHUB_REPOSITORY="owner/repo"
export QDRANT_URL="https://your-cluster.qdrant.io"
export QDRANT_API_KEY="your-qdrant-key"
export EMBEDDING_API_KEY="your-embedding-key"

uvx .github/scripts/improve_issue.py --index-issues
# → 全Issueを取得してベクトル化
# → Qdrantに登録
```

**範囲指定登録:**
```bash
uvx .github/scripts/improve_issue.py --index-issues --start 1 --end 100
# → Issue #1〜#100 を処理
```

**動作詳細:**
1. GitHub API経由で既存Issueを取得（読取り）
2. 全Issue（または指定範囲）を対象
3. 各Issueに対して：
   - Issue本文 + タイトルを結合
   - Embedding APIでベクトル化
   - Qdrantに登録（メタデータ含む）
4. 進捗を標準出力に表示
5. エラー発生時も継続処理（ログ出力）

**メタデータ:**
- `issue_number`: Issue番号
- `issue_title`: タイトル
- `issue_body`: 本文（先頭500文字）
- `template_type`: テンプレート種別（推定）
- `state`: open/closed
- `created_at`: 作成日時
- `url`: Issue URL

**用途:**
- RAG検索用ベクトルDBの初期構築
- 新規Issueが作成された際の自動インデックス更新（Phase 2で自動化）
- 定期的な全体再インデックス

**実行タイミング:**
- Phase 2導入時の初回データ投入
- 大量Issue作成後の一括インデックス
- インデックス再構築が必要な場合

#### モード比較

| 項目 | モード1: 単一Issue改善 | モード2: RAGデータ生成 |
|------|----------------------|----------------------|
| **実行** | `uvx improve_issue.py [--dry-run]` | `uvx improve_issue.py --index-issues` |
| **対象** | 単一Issue（ISSUE_NUMBER指定） | 全Issue or 範囲指定 |
| **GitHub API** | Issue取得（読取り） | Issue取得（読取り） |
| **RAG検索** | 類似Issue検索（Phase 2） | - |
| **LLM API** | 例文生成 | - |
| **Embedding API** | - | ベクトル化 |
| **Qdrant** | 検索（読取り） | 登録（書込み） |
| **コメント投稿** | あり（--dry-runでスキップ） | なし |
| **出力** | コメント or コンソール | 進捗ログ |

### RAG（Retrieval-Augmented Generation）実装

#### ベクトルデータベース

- **採用候補**: Qdrant Cloud
- **理由**: 
  - マネージドサービスで運用負荷が低い
  - 無料枠での利用可能性
  - REST APIでアクセス可能

#### Text Embedding

- **必要処理**:
  - テキストの分割（チャンキング）
  - Embeddingベクトル生成
  - Qdrantへの登録
  
- **検討事項**:
  - Embedding生成サービスの選定（OpenAI, Cohere, Voyage AI, OSS等）
  - コスト・レイテンシのバランス
  - 日本語対応の品質

#### データ構造設計

**Issueデータの扱い:**
- Issue本文を主要なドキュメントとして扱う
- Issueコメントは従属情報として本文と関連付け
- メタデータ: Issue番号、作成日、ラベル、状態（open/closed）

**インデックス更新タイミング:**
- Issue作成時
- Issue本文・コメント更新時
- 定期バッチでの全体同期

### GitHub Actions Workflow

#### 実行環境

- **ランナー**: `ubuntu-slim` を検討（コスト削減）
- **条件**:
  - CPUコア数・メモリ使用量が少ない場合
  - 外部APIとの通信が主体の場合

#### 実行時間の制約

- GitHub Actionsは従量課金のため実行時間を最小化
- タイムアウト設定: 5分以内を目標
- 重い処理は外部サービスに委譲

#### トリガー条件

```yaml
on:
  issues:
    types: [opened, edited]
```

#### 処理フロー

1. Issue内容の解析（テンプレート判定）
2. Qdrantから類似Issue取得（Top-K件）
3. LLM APIでブラッシュアップ案生成
4. GitHub APIでコメント投稿（or 既存コメント更新）

### セキュリティ・認証

- **GitHub Token**: `GITHUB_TOKEN`（自動提供）
- **Qdrant API Key**: GitHub Secrets で管理
- **LLM API Key**: GitHub Secrets で管理

## 非機能要件

### パフォーマンス

- Workflow実行時間: 5分以内
- RAG検索レスポンス: 3秒以内
- LLM生成時間: 20秒以内

### コスト

- GitHub Actions実行時間: 月間1000分以内（無料枠活用）
- Qdrant Cloud: 無料プラン範囲内
- Embedding生成: 月間XX円以内（要算定）
- LLM API: 月間XX円以内（要算定）

### 可用性

- Workflow失敗時はIssue作成者に通知（オプション）
- 外部API障害時はグレースフルに失敗

## 実装スコープ

### Phase 0（技術検証・PoC）

**目的**: RAGなしで基本フローの動作確認、技術選定の妥当性検証

**実装内容:**
- [ ] GitHub Actions Workflowの基本構造構築
- [ ] Issue作成イベントのトリガー設定
- [ ] LLM APIとの接続確認（OpenAI/Anthropic等の選定）
- [ ] 固定プロンプトでの例文生成テスト
- [ ] Issueコメント投稿の実装

**検証ポイント:**
- GitHub Actions環境でのLLM API呼び出しが正常動作するか
- 実行時間・コストが許容範囲か
- 生成される例文の品質が使えるレベルか

**完了条件:**
- [ ] ブランクIssueに「機能追加したい」と書くと、何らかの例文がコメントされる

**期待工数**: 2-3日

---

### Phase 1（基本機能実装）

**目的**: テンプレート判定と汎用的な例文生成で最小限の価値提供

**実装内容:**
- [ ] Issue本文からのテンプレート自動判定機能
  - 要件Issue（feature-1）のみ対応
- [ ] テンプレート構造を理解したプロンプト設計
- [ ] テンプレートに沿った例文生成
- [ ] エラーハンドリングの実装
- [ ] 既存Issue（詳細記述済み）の除外ロジック

**検証ポイント:**
- テンプレート判定精度は実用的か
- 生成された例文はテンプレート項目を網羅しているか
- ユーザーが微修正で使えるか

**完了条件:**
- [ ] 簡易記述のIssueに対して、feature-1テンプレートに沿った例文が生成される
- [ ] テンプレート判定精度70%以上（手動評価10件）

**期待工数**: 3-5日

---

### Phase 2（RAG機能追加）

**目的**: 過去の類似Issue情報を活用し、より具体的で実用的な例文を生成

**実装内容:**
- [ ] Qdrant Cloudのセットアップ
- [ ] Embedding生成サービスの選定・実装
- [ ] 既存Issue情報のベクトル化とインデックス登録
- [ ] 類似Issue検索機能の実装
- [ ] 検索結果をプロンプトに含めた例文生成
- [ ] 参考にしたIssueをコメントに明示

**検証ポイント:**
- 類似Issue検索の適合率は十分か
- RAG導入により例文の具体性・品質が向上したか
- 実行時間・コストは許容範囲か

**完了条件:**
- [ ] 類似Issue Top-3を取得し、それを参考にした例文が生成される
- [ ] 類似Issue適合率60%以上
- [ ] 例文の具体性がPhase 1より向上（主観評価）

**期待工数**: 5-7日

---

### Phase 3（複数テンプレート対応）

**目的**: 要件以外のIssueタイプにも対応し、適用範囲を拡大

**実装内容:**
- [ ] 設計Issue（feature-2-design）テンプレート対応
- [ ] バグ報告（bug_report）テンプレート対応
- [ ] 実装Issue（feature-3-coding）テンプレート対応
- [ ] 各テンプレート用のプロンプト最適化
- [ ] テンプレート判定精度の向上

**検証ポイント:**
- 4種類のテンプレートを正しく判別できるか
- 各テンプレートで適切な例文が生成されるか

**完了条件:**
- [ ] 4種類すべてのテンプレートに対応
- [ ] テンプレート判定精度80%以上

**期待工数**: 3-5日

---

### Phase 4（運用改善・品質向上）

**目的**: 継続的な利用に向けた改善とフィードバック機構の実装

**実装内容:**
- [ ] Issue本文更新時の再生成機能
- [ ] 生成コメントの更新（上書き）機能
- [ ] プロジェクトドキュメント（`.dev/`配下）の参考情報化
- [ ] ユーザーフィードバック機能（👍/👎リアクション検知）
- [ ] 生成品質の継続的モニタリング
- [ ] プロンプトのA/Bテスト基盤

**検証ポイント:**
- ユーザー満足度は向上したか
- フィードバックを元にした改善が機能するか

**完了条件:**
- [ ] ユーザーが「使いやすくなった」と感じる（アンケート）
- [ ] 生成品質の定量的な向上を確認

**期待工数**: 5-7日

---

### スコープ外（将来検討事項）

- Issue優先度の自動判定
- 工数見積もりの自動算出
- PRへの自動レビューコメント
- 類似Issue間の依存関係の自動検出

## 技術的検討事項

### 要検討項目

1. **Embedding生成サービスの選定**
   - OpenAI text-embedding-3-small/large
   - Cohere Embed
   - Voyage AI
   - OSS（sentence-transformers等）
   - Qdrant fastembed

2. **チャンキング戦略**
   - Issue本文の分割単位（文字数・段落単位）
   - コメントの扱い（個別 or 連結）
   - 重複・オーバーラップの設定

3. **RAG検索パラメータ**
   - 類似Issue取得件数（Top-K）
   - スコア閾値
   - フィルタリング条件（ラベル、状態等）

4. **LLMプロンプト設計**
   - システムプロンプトの定義
   - Few-shotサンプルの用意
   - 出力形式の制約

5. **Workflow実行最適化**
   - キャッシング戦略
   - 並列実行可能性
   - 失敗時のリトライロジック

## 議論ポイント

1. **技術的実現性**
   - RAG基盤の構築難易度
   - GitHub Actions環境での実行可能性
   - 各種APIの統合複雑度

2. **コスト対効果**
   - API利用料金の試算
   - 開発・運用コストの見積もり
   - 期待される効果（Issue品質向上）の定量化

3. **運用負荷**
   - Embedding更新の頻度・タイミング
   - エラー監視・アラート設計
   - プロンプト・パラメータのチューニング作業

4. **代替案検討**
   - ローカルLLM（Ollama等）の利用可能性
   - より簡易な実装（テンプレートチェックのみ）
   - 手動トリガーでの運用

## 関連ドキュメント

- GitHub Issue Template: `.github/ISSUE_TEMPLATE/feature-1.md`（要件）
- GitHub Issue Template: `.github/ISSUE_TEMPLATE/feature-2-design.md`（設計）
- Qdrant Documentation: https://qdrant.tech/documentation/
- GitHub Actions Documentation: https://docs.github.com/actions

## 備考

- 本要件は技術的な実現可能性の議論を目的としている
- 詳細な技術設計は別途設計Issueで実施
- 各種APIの選定・評価は別途調査タスクとして実施
