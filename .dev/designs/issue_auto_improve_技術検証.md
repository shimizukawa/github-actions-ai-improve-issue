# æŠ€è¡“æ¤œè¨¼: Issueè‡ªå‹•ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ©Ÿèƒ½

## æ¦‚è¦

Issueè‡ªå‹•ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿç¾å¯èƒ½æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã€Phase 0ï¼ˆæŠ€è¡“æ¤œè¨¼ãƒ»PoCï¼‰ã¨ã—ã¦ä»¥ä¸‹ã®æŠ€è¡“è¦ç´ ã‚’èª¿æŸ»ãƒ»æ¤œè¨¼ã™ã‚‹ã€‚

## æ¤œè¨¼ç›®çš„

- GitHub Actionsç’°å¢ƒã§ã®LLM APIå‘¼ã³å‡ºã—ã®å‹•ä½œç¢ºèª
- å®Ÿè¡Œæ™‚é–“ãƒ»ã‚³ã‚¹ãƒˆã®å®Ÿæ¸¬
- ç”Ÿæˆã•ã‚Œã‚‹ä¾‹æ–‡ã®å“è³ªè©•ä¾¡
- æŠ€è¡“é¸å®šã®å¦¥å½“æ€§æ¤œè¨¼

## æ¤œè¨¼é …ç›®

### 1. LLM APIé¸å®š

#### æ¤œè¨¼å¯¾è±¡ï¼ˆ2025å¹´11æœˆæ™‚ç‚¹ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | ãƒ¢ãƒ‡ãƒ« | ç‰¹å¾´ | å…¥åŠ›/100ä¸‡T | å‡ºåŠ›/100ä¸‡T |
|---------|--------|------|------------|------------|
| **Google** | Gemini 2.0 Flash-Lite | è¶…ä½ã‚³ã‚¹ãƒˆã€æ¤œè¨¼å‘ã‘ | $0.075 | $0.30 |
| **Google** | Gemini 2.5 Flash | ã‚³ã‚¹ãƒ‘è‰¯å¥½ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¨è«– | $0.30 | $2.50 |
| **Anthropic** | Claude 3.7 Sonnet | æœ€æ–°ã€æ¨è«–å¼·åŒ–ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‘ã‘ | $3.00 | $15.00 |
| **OpenAI** | GPT-4o-mini | ãƒãƒ©ãƒ³ã‚¹å‹ã€ä½ã‚³ã‚¹ãƒˆ | $0.15 | $0.60 |

#### æ¤œè¨¼å†…å®¹

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:**
```
ä»¥ä¸‹ã®Issueè¨˜è¿°ã‚’ã€feature-1ï¼ˆæ©Ÿèƒ½è¦ä»¶ï¼‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ²¿ã£ãŸå…·ä½“çš„ãªå†…å®¹ã«æ‹¡å¼µã—ã¦ãã ã•ã„ã€‚

ã€Issueè¨˜è¿°ã€‘
æƒ³å®šé‹è»¢ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ç™»éŒ²æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
ï¼ˆfeature-1ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹é€ ã‚’æç¤ºï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
Markdownå½¢å¼ã§ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å„é …ç›®ã‚’åŸ‹ã‚ã¦ãã ã•ã„ã€‚
```

**è©•ä¾¡æŒ‡æ¨™:**
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé …ç›®ã®ç¶²ç¾…ç‡
- ç”Ÿæˆå†…å®¹ã®å…·ä½“æ€§ï¼ˆæŠ½è±¡çš„ã™ããªã„ã‹ï¼‰
- ç”Ÿæˆå†…å®¹ã®å¦¥å½“æ€§ï¼ˆæ˜ã‚‰ã‹ãªèª¤ã‚ŠãŒãªã„ã‹ï¼‰
- ç”Ÿæˆæ™‚é–“
- APIåˆ©ç”¨ã‚³ã‚¹ãƒˆï¼ˆ1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ãŸã‚Šï¼‰

**æƒ³å®šçµæœï¼ˆ2025å¹´11æœˆæ›´æ–°ï¼‰:**
- Gemini 2.0 Flash-Lite: ä¸­å“è³ªã€10ç§’ã€$0.002-0.003
- Gemini 2.5 Flash: é«˜å“è³ªã€12ç§’ã€$0.015-0.020
- Claude 3.7 Sonnet: æœ€é«˜å“è³ªã€15ç§’ã€$0.024-0.030
- GPT-4o-mini: é«˜å“è³ªã€10ç§’ã€$0.004-0.006

**å‚è€ƒ: 2025å¹´10æœˆ Nejumi Leaderboard æ—¥æœ¬èªLLMãƒ©ãƒ³ã‚­ãƒ³ã‚°**
- Gemini 2.5 Pro: 1ä½ï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ€§èƒ½ 0.6449ï¼‰
- OpenAI o4-mini: 2ä½ï¼ˆ0.6444ï¼‰
- Claude 3.7 Sonnet: 8ä½ï¼ˆ0.5940ã€å®Ÿè£…ã‚¿ã‚¹ã‚¯å‘ã‘ï¼‰
- Gemini 2.5 Flash: 30ä½ï¼ˆ0.5004ã€ã‚³ã‚¹ãƒ‘é‡è¦–ï¼‰

#### æ¨å¥¨é¸å®šï¼ˆ2025å¹´11æœˆæ›´æ–°ï¼‰

**Phase 0-1**: Gemini 2.0 Flash-Liteï¼ˆæ¥µä½ã‚³ã‚¹ãƒˆã€æ¤œè¨¼é€Ÿåº¦å„ªå…ˆï¼‰
- ä»£æ›¿: Gemini 2.5 Flashï¼ˆå“è³ªé‡è¦–ã®å ´åˆï¼‰

**Phase 2ä»¥é™**: Claude 3.7 Sonnetï¼ˆæœ€æ–°ç‰ˆã€æ¨è«–èƒ½åŠ›å¼·åŒ–ï¼‰
- æ‹¡å¼µæ€è€ƒãƒ¢ãƒ¼ãƒ‰ï¼ˆThinkingï¼‰å¯¾å¿œã§åˆ¤å®šç²¾åº¦å‘ä¸Šã®å¯èƒ½æ€§
- ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–¢é€£ã‚¿ã‚¹ã‚¯ã«å¼·ã„

**Phase 2ä»£æ›¿æ¡ˆ**: Gemini 2.5 Flashï¼ˆã‚³ã‚¹ãƒˆé‡è¦–ã®å ´åˆï¼‰
- Claude 3.7ã®ç´„1/10ã®ã‚³ã‚¹ãƒˆã§ä¸­ç¨‹åº¦ã®å“è³ª

### 2. GitHub Actions Workflowå®Ÿè£…

#### æ¤œè¨¼å†…å®¹

**åŸºæœ¬Workflowæ§‹é€ :**
```yaml
name: Issue Auto Improve

on:
  issues:
    types: [opened]

jobs:
  improve-issue:
    runs-on: ubuntu-latest           # æ¨™æº–ãƒ©ãƒ³ãƒŠãƒ¼ (2ã‚³ã‚¢7GB)
    timeout-minutes: 2               # APIå‘¼ã³å‡ºã—ä¸­å¿ƒã®å‡¦ç†ã§15-20ç§’ç¨‹åº¦
    # æ³¨: ubuntu-slim (1ã‚³ã‚¢5GB) ã§ã‚‚ååˆ†å®Ÿè¡Œå¯èƒ½
    
    steps:
      - name: Check if issue needs improvement
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // çŸ­ã„è¨˜è¿°ï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰ã®ã¿å‡¦ç†
            if (body.length > 200) {
              core.setOutput('needs_improvement', 'false');
              return;
            }
            
            // æ—¢ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ²¿ã£ã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (body.includes('## èƒŒæ™¯ãƒ»ç›®çš„') || body.includes('## å®Œäº†æ¡ä»¶')) {
              core.setOutput('needs_improvement', 'false');
              return;
            }
            
            core.setOutput('needs_improvement', 'true');
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      
      - name: Generate improved content and post comment
        if: steps.check.outputs.needs_improvement == 'true'
        id: generate
        run: |
          # uvx ã§ PEP-723å¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§GitHub CLI (gh)çµŒç”±ã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
          uvx .github/scripts/improve_issue.py
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      - name: Handle errors
        if: failure()
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body 'âš ï¸ Issueè‡ªå‹•æ”¹å–„æ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§Issueå†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**æ¤œè¨¼é …ç›®:**
- [ ] WorkflowãŒæ­£å¸¸ã«èµ·å‹•ã™ã‚‹ã‹
- [ ] Issueæœ¬æ–‡ã®å–å¾—ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
- [ ] ç’°å¢ƒå¤‰æ•°ï¼ˆSecretsï¼‰ã®å—ã‘æ¸¡ã—ãŒå‹•ä½œã™ã‚‹ã‹
- [ ] LLM APIå‘¼ã³å‡ºã—ãŒæˆåŠŸã™ã‚‹ã‹
- [ ] GitHub CLI (gh)çµŒç”±ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãŒæˆåŠŸã™ã‚‹ã‹
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ2åˆ†ä»¥å†…ã‹ï¼ˆå®Ÿéš›ã¯15-20ç§’ç¨‹åº¦ã‚’æƒ³å®šï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã‹
- [ ] --dry-runãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ãŒå¯èƒ½ã‹
- [ ] ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ï¼ˆCPU/ãƒ¡ãƒ¢ãƒªï¼‰ãŒæƒ³å®šç¯„å›²å†…ã‹

**æƒ³å®šèª²é¡Œã¨å¯¾ç­–:**
| èª²é¡Œ | å¯¾ç­– |
|------|------|
| APIå‘¼ã³å‡ºã—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤èª¿æ•´ |
| Secretsç®¡ç† | GitHub Secretsä½¿ç”¨ã€ç’°å¢ƒå¤‰æ•°ã§å—ã‘æ¸¡ã— |
| å®Ÿè¡Œæ™‚é–“è¶…é | å‡¦ç†ã®ä¸¦åˆ—åŒ–ã€è»½é‡ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ |
| é‡è¤‡ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ | Workflowå®Ÿè¡Œå±¥æ­´ãƒã‚§ãƒƒã‚¯ã€ã‚³ãƒ¡ãƒ³ãƒˆå­˜åœ¨ç¢ºèª |

### 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

#### æ¤œè¨¼å†…å®¹

**åˆ¤å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:**
```
ä»¥ä¸‹ã®Issueè¨˜è¿°ã‹ã‚‰ã€æœ€ã‚‚é©åˆ‡ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚

ã€Issueè¨˜è¿°ã€‘
{issue_body}

ã€é¸æŠè‚¢ã€‘
1. feature-1: æ©Ÿèƒ½è¦ä»¶ï¼ˆæ–°æ©Ÿèƒ½ã®è¿½åŠ ã€æ—¢å­˜æ©Ÿèƒ½ã®å¤‰æ›´ï¼‰
2. feature-2-design: æ©Ÿèƒ½è¨­è¨ˆï¼ˆå®Ÿè£…æ–¹é‡ã€æŠ€è¡“é¸å®šã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
3. bug_report: ãƒã‚°å ±å‘Šï¼ˆä¸å…·åˆã€ã‚¨ãƒ©ãƒ¼ã€æƒ³å®šå¤–ã®å‹•ä½œï¼‰
4. feature-3-coding: å®Ÿè£…ï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
é¸æŠã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: feature-1ï¼‰
```

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:**
| Issueè¨˜è¿° | æœŸå¾…ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ |
|-----------|------------------|
| ã€Œæƒ³å®šé‹è»¢ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬ç™»éŒ²æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„ã€ | feature-1 |
| ã€Œä¸€æ‹¬ç™»éŒ²ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã‚’æ¤œè¨ã—ãŸã„ã€ | feature-2-design |
| ã€ŒCSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€ | bug_report |
| ã€ŒOpePlan.save()ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã€ | feature-3-coding |

**è©•ä¾¡æŒ‡æ¨™:**
- åˆ¤å®šç²¾åº¦ï¼ˆ10ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§è©•ä¾¡ï¼‰
- åˆ¤å®šæ™‚é–“

**æƒ³å®šçµæœ:**
- åˆ¤å®šç²¾åº¦: 80-90%
- åˆ¤å®šæ™‚é–“: 2-5ç§’

#### èª¤åˆ¤å®šæ™‚ã®å¯¾ç­–

- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§åˆ¤å®šåŸºæº–ã‚’æ˜ç¢ºåŒ–
- Few-shotä¾‹ã‚’è¿½åŠ ï¼ˆå„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ2-3ä¾‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ä¿®æ­£å¯èƒ½ãªã‚³ãƒ¡ãƒ³ãƒˆå½¢å¼

### 4. ã‚³ã‚¹ãƒˆè©¦ç®—

#### æƒ³å®šåˆ©ç”¨é‡

- Issueä½œæˆé »åº¦: æœˆ20ä»¶
- å‡¦ç†å¯¾è±¡ï¼ˆç°¡æ˜“è¨˜è¿°ï¼‰: æœˆ10ä»¶ï¼ˆ50%ï¼‰
- å†ç”Ÿæˆï¼ˆIssueæ›´æ–°ï¼‰: æœˆ5ä»¶

**åˆè¨ˆ: æœˆ15ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**

#### ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆ2025å¹´11æœˆæ›´æ–°ï¼‰

**Gemini 2.0 Flash-Lite:**
- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 500ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ Ã— $0.075/1M = $0.0000375
- å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 1500ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ Ã— $0.30/1M = $0.00045
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.00048 Ã— 15 = **$0.007/æœˆï¼ˆç´„1å††ï¼‰**

**Gemini 2.5 Flash:**
- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $0.30/1M = $0.00015
- å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 1500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $2.50/1M = $0.00375
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.00390 Ã— 15 = **$0.059/æœˆï¼ˆç´„9å††ï¼‰**

**Claude 3.7 Sonnet:**
- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $3/1M = $0.0015
- å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 1500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $15/1M = $0.0225
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.024 Ã— 15 = **$0.36/æœˆï¼ˆç´„54å††ï¼‰**

**GPT-4o-mini:**
- å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $0.15/1M = $0.000075
- å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: 1500ãƒˆãƒ¼ã‚¯ãƒ³ Ã— $0.60/1M = $0.0009
- æœˆé–“ã‚³ã‚¹ãƒˆ: $0.000975 Ã— 15 = **$0.015/æœˆï¼ˆç´„2å††ï¼‰**

**GitHub Actions:**
- å®Ÿè¡Œæ™‚é–“: 2åˆ†/å› Ã— 15å› = 30åˆ†/æœˆ
- ã‚³ã‚¹ãƒˆ: ç„¡æ–™æ 2000åˆ†å†…ã§åã¾ã‚‹ï¼ˆ**$0**ï¼‰

**åˆè¨ˆæƒ³å®šã‚³ã‚¹ãƒˆ: æœˆ1-54å††ï¼ˆãƒ¢ãƒ‡ãƒ«é¸æŠã«ã‚ˆã‚‹ï¼‰**

| ãƒ¢ãƒ‡ãƒ« | æœˆé¡ã‚³ã‚¹ãƒˆ | ç”¨é€” |
|--------|-----------|------|
| Gemini 2.0 Flash-Lite | ç´„1å†† | Phase 0æ¤œè¨¼ |
| GPT-4o-mini | ç´„2å†† | ä½ã‚³ã‚¹ãƒˆé‹ç”¨ |
| Gemini 2.5 Flash | ç´„9å†† | ã‚³ã‚¹ãƒ‘é‡è¦–é‹ç”¨ |
| Claude 3.7 Sonnet | ç´„54å†† | å“è³ªé‡è¦–é‹ç”¨ |

### 5. å®Ÿè£…è¨€èªãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸å®š

#### Pythonå®Ÿè£…

**æ¨å¥¨æ§‹æˆ:**
```
.github/
â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ issue_auto_improve.yml
â””â”€â”€ scripts/
    â””â”€â”€ improve_issue.py          # å˜ä¸€ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPEP-723å¯¾å¿œï¼‰
```

**ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†:**

PEP-723ã‚’ä½¿ç”¨ã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ä¾å­˜é–¢ä¿‚ã‚’å®£è¨€ï¼š
```python
# /// script
# dependencies = [
#   "google-generativeai>=0.8.3",
# ]
# ///
```

**å®Ÿè£…ä¾‹ï¼ˆimprove_issue.pyï¼‰:**
```python
# /// script
# dependencies = [
#   "google-generativeai>=0.8.3",
# ]
# ///
import argparse
import os
import sys
import subprocess
import tempfile
from llm_client import LLMClient
from template_detector import TemplateDetector
from prompt_templates import IMPROVE_PROMPT_TEMPLATE

def main():
    # å¼•æ•°è§£æ
    parser = argparse.ArgumentParser()
    parser.add_argument('--dry-run', action='store_true',
                        help='ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ç”¨ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¹ã‚­ãƒƒãƒ—ï¼‰')
    args = parser.parse_args()
    
    issue_body = os.environ.get('ISSUE_BODY', '')
    issue_title = os.environ.get('ISSUE_TITLE', '')
    issue_number = os.environ.get('ISSUE_NUMBER', '')
    
    print(f"Processing issue #{issue_number}")
    
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ¤å®š
    detector = TemplateDetector()
    template_name = detector.detect(issue_body, issue_title)
    print(f"Detected template: {template_name}")
    
    # ä¾‹æ–‡ç”Ÿæˆ
    client = LLMClient(api_key=os.environ['LLM_API_KEY'])
    prompt = IMPROVE_PROMPT_TEMPLATE.format(
        issue_body=issue_body,
        issue_title=issue_title,
        template_name=template_name
    )
    improved_content = client.generate(prompt)
    print("Content generated successfully")
    
    # å‡ºåŠ›å†…å®¹ä½œæˆ
    output = f"""## ğŸ¤– AIã«ã‚ˆã‚‹Issueè¨˜å…¥ä¾‹

**é¸å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: {template_name}

---

{improved_content}

---

ğŸ’¡ **ä½¿ã„æ–¹**: ä¸Šè¨˜ã®ä¾‹æ–‡ã‚’å‚è€ƒã«ã€Issueæœ¬æ–‡ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
"""
    
    # --dry-run ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã®ã¿
    if args.dry_run:
        print("[DRY RUN] ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—")
        print("\n" + "="*60)
        print(output)
        print("="*60)
        return
    
    # é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: GitHub CLIã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
    with tempfile.NamedTemporaryFile(mode='w', encoding='utf-8', 
                                      suffix='.md', delete=False) as f:
        f.write(output)
        temp_file = f.name
    
    try:
        subprocess.run(
            ['gh', 'issue', 'comment', issue_number, '--body-file', temp_file],
            capture_output=True, text=True, check=True
        )
        print(f"Comment posted successfully to issue #{issue_number}")
    finally:
        os.unlink(temp_file)

if __name__ == '__main__':
    main()
```

**ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼æ–¹æ³•:**

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
export ISSUE_BODY="æƒ³å®šé‹è»¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç™»éŒ²ã—ãŸã„"
export ISSUE_TITLE="æƒ³å®šé‹è»¢ãƒ‡ãƒ¼ã‚¿CSVä¸€æ‹¬ç™»éŒ²æ©Ÿèƒ½"
export ISSUE_NUMBER="123"
export LLM_API_KEY="your-api-key"

# --dry-run ãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãªã—ï¼‰
uvx .github/scripts/improve_issue.py --dry-run
```

## æ¤œè¨¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Week 1: ç’°å¢ƒæ§‹ç¯‰ãƒ»åŸºæœ¬å‹•ä½œç¢ºèª

- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§--dry-runãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œç¢ºèª
- [ ] LLM APIï¼ˆGeminiï¼‰ã®æ¥ç¶šç¢ºèª
- [ ] GitHub Actions Workflowã®åŸºæœ¬æ§‹é€ ä½œæˆ
- [ ] GitHub CLI (gh)çµŒç”±ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç¢ºèª
- [ ] Issueä½œæˆâ†’ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã®å‹•ä½œç¢ºèª

### Week 2: å“è³ªè©•ä¾¡ãƒ»æ”¹å–„

- [ ] 10ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä¾‹æ–‡ç”Ÿæˆ
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ¤å®šç²¾åº¦ã®æ¸¬å®š
- [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- [ ] ã‚³ã‚¹ãƒˆãƒ»å®Ÿè¡Œæ™‚é–“ã®å®Ÿæ¸¬

### Week 3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»æœ€é©åŒ–

- [ ] APIéšœå®³æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] é‡è¤‡æŠ•ç¨¿é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

## æˆåŠŸåŸºæº–

### å¿…é ˆæ¡ä»¶

- [ ] GitHub Actions WorkflowãŒæ­£å¸¸å‹•ä½œ
- [ ] LLM APIã‹ã‚‰ã®ä¾‹æ–‡ç”ŸæˆãŒæˆåŠŸ
- [ ] Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãŒæˆåŠŸ
- [ ] å®Ÿè¡Œæ™‚é–“ãŒ2åˆ†ä»¥å†…ï¼ˆå®Ÿæ¸¬15-20ç§’ã‚’æƒ³å®šï¼‰
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ¤å®šç²¾åº¦ãŒ70%ä»¥ä¸Š
- [ ] GitHub Actionsãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ãŒæƒ³å®šå†…ï¼ˆCPUå¹³å‡10%ã€ãƒ¡ãƒ¢ãƒªãƒ”ãƒ¼ã‚¯180MBä»¥ä¸‹ï¼‰

### æ¨å¥¨æ¡ä»¶

- [ ] ç”Ÿæˆä¾‹æ–‡ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé …ç›®ã‚’80%ä»¥ä¸Šç¶²ç¾…
- [ ] æœˆé–“ã‚³ã‚¹ãƒˆãŒ100å††ä»¥å†…
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãŒæ©Ÿèƒ½

## ãƒªã‚¹ã‚¯ãƒ»èª²é¡Œ

### æŠ€è¡“çš„ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | ç™ºç”Ÿç¢ºç‡ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|---------|--------|------|
| LLM APIéšœå®³ | ä¸­ | é«˜ | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| ç”Ÿæˆå“è³ªä½ä¸‹ | ä¸­ | ä¸­ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ã€ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ |
| å®Ÿè¡Œæ™‚é–“è¶…é | ä½ | ä¸­ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã€è»½é‡åŒ– |
| GitHub Actionséšœå®³ | ä½ | é«˜ | æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ |

### é‹ç”¨ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | ç™ºç”Ÿç¢ºç‡ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|---------|--------|------|
| ã‚³ã‚¹ãƒˆè¶…é | ä½ | ä½ | æœˆæ¬¡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ä¸Šé™è¨­å®š |
| èª¤åˆ¤å®šãƒ»ä¸é©åˆ‡ãªä¾‹æ–‡ | ä¸­ | ä½ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ä¿®æ­£å¯èƒ½ |
| Secretsæ¼æ´© | ä½ | é«˜ | GitHub Secretsä½¿ç”¨ã€ãƒ­ã‚°å‡ºåŠ›åˆ¶é™ |

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¤œè¨¼å®Œäº†å¾Œã€ä»¥ä¸‹ã®åˆ¤æ–­ã‚’è¡Œã†ï¼š

### Goåˆ¤æ–­åŸºæº–

- å¿…é ˆæ¡ä»¶ã‚’ã™ã¹ã¦æº€ãŸã™
- æœˆé–“ã‚³ã‚¹ãƒˆãŒäºˆç®—å†…ï¼ˆ100å††ä»¥å†…ï¼‰
- ç”Ÿæˆä¾‹æ–‡ã®å“è³ªãŒå®Ÿç”¨ãƒ¬ãƒ™ãƒ«

â†’ **Phase 1ï¼ˆåŸºæœ¬æ©Ÿèƒ½å®Ÿè£…ï¼‰ã¸é€²ã‚€**

### No Goåˆ¤æ–­åŸºæº–

- å¿…é ˆæ¡ä»¶ã‚’æº€ãŸã›ãªã„é …ç›®ãŒã‚ã‚‹
- ã‚³ã‚¹ãƒˆãŒäºˆç®—ã‚’å¤§å¹…ã«è¶…é
- ç”Ÿæˆä¾‹æ–‡ã®å“è³ªãŒä½ã™ãã‚‹

â†’ **ä»£æ›¿æ¡ˆæ¤œè¨ï¼ˆæ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã€ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã®ã¿ç­‰ï¼‰**

## å‚è€ƒæƒ…å ±

- GitHub Actions Documentation: https://docs.github.com/actions
- Gemini API Documentation: https://ai.google.dev/docs
- Claude API Documentation: https://docs.anthropic.com/
- OpenAI API Documentation: https://platform.openai.com/docs
